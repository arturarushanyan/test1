/* global VBET5 */
/**
 * @ngdoc directive
 * @name vbet5.directive:mbScrollbar
 * @description Scrollbar styles
 *
 */

VBET5.directive("mbScrollbar",function(){"use strict";return{restrict:"A",transclude:!0,scope:{config:"=mbScrollbar"},template:"<div class='ngscroll-resizable' style='position: relative; width: 100%;height: 100%; float: left'> <div class='ngscroll-container' style='width: 100%; height: 100%;float: left' ng-transclude></div> <div class='ngscroll-scrollbar-container' ng-style='styles.scrollbarContainer'><div class='ngscroll-scrollbar' ng-style='styles.scrollbar'></div></div> </div>",link:function(a,b){function c(a,b){return"horizontal"==e.direction?b:a}function d(a,b){for(var c in b)(b||{}).hasOwnProperty(c)&&(a||{}).hasOwnProperty(c)&&("object"==typeof a[c]?a[c]=d(a[c],b[c]):a[c]=b[c]);return a}function l(a){var b="margin-"+e.position,c=parseInt(f.css(b)||0)+a;m(c)}function m(a){var b="margin-"+e.position,c=Math.min(0,Math.max(a,-k+i)),d=-c/k;f.css(b,c+"px"),h.css(e.position,d*i+e.scrollbar.margin+"px")}function n(){h.css("opacity",0)}function o(){h.css("opacity",1)}var e={autoResize:!1,direction:(a.config||{}).direction||"vertical",scrollbar:{width:4,hoverWidth:4,color:"rgb(186, 185, 179)",show:!0,"border-radius":"4"},scrollbarContainer:{width:4,color:"#f3f2e9"},dragSpeedModifier:1,firefoxModifier:40,scrollTo:(a.config||{}).scrollTo||null};e.dimension=c("height","width"),e.rDimension=c("width","height"),e.position=c("top","left"),e.rPosition=c("right","bottom"),e=d(e,a.config||{}),e.scrollbar.margin=(e.scrollbarContainer.width-e.scrollbar.width)/2,e.scrollbar.hoverMargin=(e.scrollbarContainer.width-e.scrollbar.hoverWidth)/2;var j,f=angular.element(b[0].querySelector(".ngscroll-container")),g=angular.element(b[0].querySelector(".ngscroll-scrollbar-container")),h=angular.element(g.children()[0]),i=0,k=0;a.styles={scrollbar:{position:"absolute",cursor:"default",opacity:e.scrollbar.show?1:0,background:e.scrollbar.color,"border-radius":e.scrollbar.width+"px"},scrollbarContainer:{position:"absolute",transition:"background .3s ease-in-out","border-radius":e.scrollbarContainer.width/2+"px",background:e.scrollbarContainer.color}},h.css(e.rDimension,e.scrollbar.width+"px"),h.css(e.rPosition,e.scrollbar.margin+"px"),h.css(e.position,e.scrollbar.margin+"px"),g.css(e.rPosition,"-4px"),g.css(e.position,"0"),g.css(e.dimension,"100%"),g.css(e.rDimension,e.scrollbarContainer.width+"px");var p=function(){c(function(){f.css("height","auto"),k=f[0].scrollHeight||0},function(){k=0;for(var a=f.children(),b=0;b<a.length;b++)k+=a[b].offsetWidth})(),i=c(b[0].offsetHeight,b[0].offsetWidth),e.dragSpeedModifier=Math.max(1,1/(j/i)),f.css(e.dimension,k+"px"),i>=k?(k=i,b.addClass("no-scrollbar"),b.removeClass("has-scrollbar"),n()):(b.addClass("has-scrollbar"),b.removeClass("no-scrollbar"),e.scrollbar.show&&o()),j=i/k*i-e.scrollbar.margin,h.css(e.dimension,j+"px"),h.css("transition","opacity .3s ease-in-out, border-radius .1s linear, "+e.rDimension+" .1s linear, "+e.rPosition+" .1s linear"),null==e.scrollTo?l(0):m("start"==e.scrollTo?0:"end"==e.scrollTo?-k+i:-parseInt(e.scrollTo))};if("function"==typeof MutationObserver){var q=new MutationObserver(function(a){setTimeout(function(){p()},200)});q.observe(b[0],{childList:!0,subtree:!0,characterData:!0,attributes:!0})}else e.autoResize===!0&&(f.on("DOMNodeInserted",p),f.on("DOMNodeRemoved",p));a.$on("recalculateMBScrollbars",function(a){setTimeout(function(){p()},5)}),a.$on("scrollToMBScrollbars",function(a,b){setTimeout(function(){m(b)},5)}),f.on("mousewheel",function(a){a.preventDefault(),void 0!=a.originalEvent&&(a=a.originalEvent);var b=c(a.wheelDeltaY||a.wheelDelta,a.wheelDeltaX||a.wheelDeltaY||a.wheelDelta);l(b)}),window.navigator.userAgent.toLowerCase().indexOf("firefox")>=0&&f.on("wheel",function(a){a.preventDefault(),void 0!=a.originalEvent&&(a=a.originalEvent);var b=c(a.deltaY,a.deltaX>0?a.deltaX:a.deltaY);return l(-b*e.firefoxModifier),!1});var r,s;h.on("mousedown",function(a){return a.preventDefault(),r=!0,angular.element(document).on("mouseup",function(){r=!1,e.scrollbar.show||n()}),s=c(a.screenY,a.screenX),!1}),angular.element(document).on("mousemove",function(a){if(r){a.preventDefault();var b=c(a.screenY,a.screenX)-s;b*=e.dragSpeedModifier,s+=b*(j/i),l(-b)}}),e.scrollbar.show||(b.on("mouseenter",o),g.on("mouseenter",o),b.on("mouseleave",function(){r||n()})),p()}}}).service("mbScrollbar",function(){this.recalculate=function(a){setTimeout(function(){a.$broadcast("recalculateMBScrollbars")},5)},this.scrollTo=function(a,b){setTimeout(function(){a.$broadcast("scrollToMBScrollbars",b)},5)}});