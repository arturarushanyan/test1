/* global VBET5 */
/**
 * @ngdoc directive
 * @name vbet5.directive:mbScrollbar
 * @description Scrollbar styles
 *
 */

VBET5.directive("mbScrollbar",function(){return{restrict:"A",transclude:!0,scope:{config:"=mbScrollbar"},template:"<div class='ngscroll-resizable' style='position:relative;width:100%;height:100%;float:left;'> <div class='ngscroll-container' style='width: 100%; height: 100%;float:left' ng-transclude></div> <div class='ngscroll-scrollbar-container' ng-style='styles.scrollbarContainer'><div class='ngscroll-scrollbar' ng-style='styles.scrollbar'></div></div> </div>",link:function(a,b){function c(a,b){return"horizontal"==e.direction?b:a}function d(a,b){for(var c in b)(b||{}).hasOwnProperty(c)&&(a||{}).hasOwnProperty(c)&&("object"==typeof a[c]?a[c]=d(a[c],b[c]):a[c]=b[c]);return a}function l(a){var b="margin-"+e.position,c=parseInt(f.css(b)||0)+a;m(c)}function m(a){var b="margin-"+e.position,c=Math.min(0,Math.max(a,-k+i)),d=-c/k;f.css(b,c+"px"),h.css(e.position,d*i+e.scrollbar.margin+"px")}var e={autoResize:!1,direction:(a.config||{}).direction||"vertical",scrollbar:{width:4,color:"rgba(0,0,0,.6)",show:!1},scrollbarContainer:{width:4,color:"rgba(0,0,0,.1)"},dragSpeedModifier:1,firefoxModifier:40,scrollTo:(a.config||{}).scrollTo||null};e.dimension=c("height","width"),e.rDimension=c("width","height"),e.position=c("top","left"),e.rPosition=c("right","bottom"),e=d(e,a.config||{}),e.scrollbar.margin=(e.scrollbarContainer.width-e.scrollbar.width)/2,e.scrollbar.hoverMargin=(e.scrollbarContainer.width-e.scrollbar.hoverWidth)/2;var j,f=angular.element(b[0].querySelector(".ngscroll-container")),g=angular.element(b[0].querySelector(".ngscroll-scrollbar-container")),h=angular.element(g.children()[0]),i=0,k=0;a.styles={scrollbar:{position:"absolute",cursor:"default",background:"rgb(186, 185, 179)","border-radius":"4px"},scrollbarContainer:{position:"absolute",transition:"all .3s ease-in-out",background:"rgba(243, 242, 233, 0.7)","border-radius":"2px"}},h.css(e.rDimension,e.scrollbar.width+"px"),h.css(e.rPosition,e.scrollbar.margin+"px"),h.css(e.position,e.scrollbar.margin+"px"),g.css(e.rPosition,"-4px"),g.css(e.position,"0"),g.css(e.dimension,"100%"),g.css(e.rDimension,e.scrollbarContainer.width+"px");var n=function(){c(function(){f.css("height","auto"),k=f[0].scrollHeight||0},function(){k=0;for(var a=f.children(),b=0;b<a.length;b++)k+=a[b].offsetWidth})(),i=c(b[0].offsetHeight,b[0].offsetWidth),e.dragSpeedModifier=Math.max(1,1/(j/i)),f.css(e.dimension,k+"px"),i>=k?(k=i,b.addClass("no-scrollbar"),b.removeClass("has-scrollbar")):(b.addClass("has-scrollbar"),b.removeClass("no-scrollbar")),j=i/k*i-2*e.scrollbar.margin,h.css(e.dimension,j+"px"),null==e.scrollTo?l(0):m("start"==e.scrollTo?0:"end"==e.scrollTo?-k+i:-parseInt(e.scrollTo))};if("function"==typeof MutationObserver){var o=new MutationObserver(function(a){setTimeout(function(){n()},200)});o.observe(b[0],{childList:!0,subtree:!0,characterData:!0,attributes:!0})}else e.autoResize===!0&&(f.on("DOMNodeInserted",n),f.on("DOMNodeRemoved",n));a.$on("recalculateMBScrollbars",function(a){setTimeout(function(){n()},5)}),a.$on("scrollToMBScrollbars",function(a,b){setTimeout(function(){m(b)},5)}),f.on("mousewheel",function(a){a.preventDefault(),void 0!=a.originalEvent&&(a=a.originalEvent);var b=c(a.wheelDeltaY||a.wheelDelta,a.wheelDeltaX||a.wheelDeltaY||a.wheelDelta);l(b,a),i<k&&a.stopPropagation()}),window.navigator.userAgent.toLowerCase().indexOf("firefox")>=0&&f.on("wheel",function(a){a.preventDefault(),void 0!=a.originalEvent&&(a=a.originalEvent);var b=c(a.deltaY,a.deltaX>0?a.deltaX:a.deltaY);return l(-b*e.firefoxModifier),i<k&&a.stopPropagation(),!1});var p,q;h.on("mousedown",function(a){return a.preventDefault(),p=!0,angular.element(document).on("mouseup",function(){p=!1}),q=c(a.screenY,a.screenX),!1}),angular.element(document).on("mousemove",function(a){if(p){a.preventDefault();var b=c(a.screenY,a.screenX)-q;b*=e.dragSpeedModifier,q+=b*(j/i),l(-b)}}),n()}}}).service("mbScrollbar",function(){this.recalculate=function(a){setTimeout(function(){a.$broadcast("recalculateMBScrollbars")},5)},this.scrollTo=function(a,b){setTimeout(function(){a.$broadcast("scrollToMBScrollbars",b)},5)}});